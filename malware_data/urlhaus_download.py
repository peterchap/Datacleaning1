# I want to download the malware data from urlhaus and save it in a polars dataframe and write out as a csv
import polars as pl
import requests
import zipfile
import io

directory = "E:/domains-monitor/"
file = "urlhaus.csv"
# Get the data from urlhaus
url = "https://urlhaus.abuse.ch/downloads/csv/"
r = requests.get(url)
# Open the ZIP file from the content
with zipfile.ZipFile(io.BytesIO(r.content)) as thezip:
    # Extract the CSV file name (assuming there is only one file in the ZIP)
    csv_filename = thezip.namelist()[0]
    print(csv_filename)

    # Read the CSV file directly from the ZIP into a Polars DataFrame
    with thezip.open(csv_filename) as csvfile:
        df = pl.read_csv(
            csvfile,
            skip_rows=9,
            has_header=False,
            new_columns=[
                "id",
                "dateadded",
                "url",
                "url_status",
                "last_online",
                "threat",
                "tags",
                "urlhaus_link",
                "reporter",
            ],
        )


# Print the first few rows
print(df.shape)
print(df.head())
df.write_csv(directory + file)
